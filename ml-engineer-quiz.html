<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Engineer Quiz ‚Ä¢ ArxCafe</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='14' fill='%234A342E'/%3E%3Ctext x='50%25' y='58%25' text-anchor='middle' font-size='34'%3Eüç∞%3C/text%3E%3C/svg%3E">
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/elearn.css">
    <style>
        .quiz-container {
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
        }
        .quiz-box {
            background: var(--color-surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 50px 30px;
            box-shadow: var(--shadow);
        }
        .hide {
            display: none !important;
        }
        .quiz-header {
            text-align: center;
            margin-bottom: 40px;
        }
        .quiz-header h1 {
            font-size: 36px;
            margin: 0 0 10px;
            color: var(--color-primary);
        }
        .subtitle {
            color: var(--color-secondary);
            margin: 0;
            font-size: 16px;
        }
        .info-box {
            background: rgba(198, 169, 146, 0.18);
            border: 1px solid rgba(74, 52, 46, 0.18);
            padding: 30px;
            border-radius: 12px;
            margin: 30px 0;
            border-left: 4px solid rgba(74, 52, 46, 0.65);
        }
        .info-box h3 {
            margin-top: 0;
            color: var(--color-primary);
        }
        .info-box ul {
            line-height: 1.8;
            color: var(--color-text);
            margin: 0;
        }
        .select-wrapper {
            max-width: 520px;
            margin: 30px auto;
        }
        .select-wrapper label {
            display: block;
            font-weight: 600;
            color: var(--color-text);
            margin: 10px 0 8px;
        }
        .select-wrapper select {
            width: 100%;
            padding: 14px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--color-surface);
            color: var(--color-text);
            font-size: 16px;
            cursor: pointer;
        }
        .select-wrapper select option {
            background: var(--color-surface);
            color: var(--color-text);
        }
        .btn {
            background: linear-gradient(135deg, rgba(198, 169, 146, 0.95), rgba(74, 52, 46, 0.95));
            color: #fff;
            padding: 16px 32px;
            font-size: 18px;
            font-weight: 600;
            border: 1px solid rgba(74, 52, 46, 0.35);
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            max-width: 520px;
            margin: 20px auto;
            display: block;
            transition: transform 0.12s ease, box-shadow 0.12s ease;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .back-link {
            text-align: center;
            margin-top: 30px;
        }
        .back-link a {
            color: var(--color-primary);
            text-decoration: none;
            border-bottom: 1px solid rgba(74, 52, 46, 0.35);
        }
        .back-link a:hover {
            color: var(--color-primary);
            border-color: rgba(74, 52, 46, 0.6);
        }
        .progress {
            background: rgba(74, 52, 46, 0.12);
            height: 8px;
            border-radius: 5px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .progress-bar {
            background: linear-gradient(90deg, rgba(198, 169, 146, 0.95), rgba(74, 52, 46, 0.95));
            height: 100%;
            width: 0;
            border-radius: 5px;
            transition: width 0.5s ease;
        }
        #progressText {
            text-align: center;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 20px;
        }
        #sectionTitle {
            text-align: center;
            color: var(--color-secondary);
            margin-bottom: 30px;
        }
        .question {
            font-size: 19px;
            font-weight: 600;
            margin-bottom: 25px;
            line-height: 1.5;
            color: var(--color-text);
        }
        .answers button {
            width: 100%;
            padding: 18px;
            margin: 10px 0;
            background: var(--color-surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            color: var(--color-text);
            transition: all 0.2s ease;
        }
        .answers button:hover {
            border-color: rgba(74, 52, 46, 0.45);
            background: rgba(198, 169, 146, 0.18);
        }
        .answers button.correct {
            border-color: rgba(46, 125, 50, 0.55);
            background: rgba(46, 125, 50, 0.12);
        }
        .answers button.wrong {
            border-color: rgba(198, 40, 40, 0.55);
            background: rgba(198, 40, 40, 0.10);
        }
        .feedback {
            margin-top: 18px;
            font-size: 16px;
            text-align: center;
            min-height: 24px;
        }
        .feedback.correct {
            color: rgba(46, 125, 50, 0.95);
        }
        .feedback.wrong {
            color: rgba(198, 40, 40, 0.95);
        }
        .result {
            text-align: center;
        }
        .result h2 {
            font-size: 32px;
            margin-bottom: 20px;
            color: var(--color-primary);
        }
        .score {
            font-size: 48px;
            font-weight: 700;
            color: var(--color-primary);
            margin: 20px 0;
        }
        #resultMsg {
            font-size: 18px;
            line-height: 1.6;
            margin: 20px 0;
            color: var(--color-text);
        }
        #categoryBreakdown {
            background: var(--color-surface);
            border: 1px solid var(--border);
            padding: 25px;
            border-radius: 12px;
            margin: 30px 0;
            text-align: left;
        }
        .explanation-btn {
            background: rgba(198, 169, 146, 0.22);
            border: 1px solid rgba(74, 52, 46, 0.25);
            color: var(--color-primary);
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s ease;
            margin-top: 12px;
        }
        .explanation-btn:hover:not(:disabled) {
            background: rgba(198, 169, 146, 0.32);
            border-color: rgba(74, 52, 46, 0.35);
        }
        .explanation-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .explanation-panel {
            background: var(--color-surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            font-size: 14px;
            line-height: 1.6;
            color: var(--color-text);
        }
        .explanation-loading {
            color: var(--color-secondary);
            font-style: italic;
        }
        .explanation-error {
            color: rgba(198, 40, 40, 0.95);
        }
        .result-btn-primary {
            display: inline-block;
            margin: 10px;
            padding: 14px 28px;
            background: linear-gradient(135deg, rgba(198, 169, 146, 0.95), rgba(74, 52, 46, 0.95));
            color: #fff;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            border: 1px solid rgba(74, 52, 46, 0.35);
        }
        .result-btn-secondary {
            display: inline-block;
            margin: 10px;
            padding: 14px 28px;
            background: var(--color-surface);
            color: var(--color-text);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        @media (max-width: 720px) {
            .quiz-container {
                margin: 20px auto;
                padding: 10px;
            }
            .quiz-box {
                padding: 30px 20px;
            }
            .quiz-header h1 {
                font-size: 28px;
            }
        }
    </style>
</head>
    <body class="quiz-page">
        <div class="app-shell">
            <header class="topbar">
                <div class="topbar-inner">
                    <button class="icon-btn" onclick="window.location.href='/assesment.html'" aria-label="Back">‚Üê</button>
                    <div class="brand">
                        ArxCafe
                        <small>Quiz</small>
                    </div>
                    <div class="avatar" aria-label="Profile" onclick="window.location.href='/profile.html'">AR</div>
                </div>
            </header>

            <main class="main">
                <div class="quiz-container">
        
        <!-- Step 1: Introduction -->
        <div id="step1" class="quiz-box">
            <div class="quiz-header">
                <h1>Professional Machine Learning Engineer Quiz</h1>
                <p class="subtitle">Comprehensive exam preparation ‚Ä¢ Practice questions covering all exam topics</p>
            </div>

            <div class="info-box">
                <h3>How This Quiz Works</h3>
                <ul>
                    <li><strong>Select a topic</strong> or <strong>All topics</strong> for comprehensive practice.</li>
                    <li>Each question has 4 choices (A‚ÄìD).</li>
                    <li>At the end you'll see your score and a per-topic breakdown.</li>
                </ul>
            </div>

            <div class="select-wrapper">
                <label for="topicSelect">Choose topic</label>
                <select id="topicSelect">
                    <option value="all">All topics (comprehensive)</option>
                    <option value="framing">Framing ML Problems</option>
                    <option value="architecture">ML Solution Architecture</option>
                    <option value="data">Data Preparation & Processing</option>
                    <option value="development">ML Model Development</option>
                    <option value="automation">ML Pipeline Automation</option>
                    <option value="monitoring">Monitoring & Optimization</option>
                </select>
            </div>

            <button class="btn" id="startBtn">Start Quiz</button>
            <p class="back-link"><a href="/assesment.html">‚Üê Back to Assessment</a></p>
        </div>

        <!-- Step 2: Quiz -->
        <div id="step2" class="quiz-box hide">
            <div class="progress"><div id="progressBar" class="progress-bar"></div></div>
            <p id="progressText"></p>
            <h3 id="sectionTitle"></h3>
            <div id="question" class="question"></div>
            <div id="answers" class="answers"></div>
            <div id="feedback" class="feedback" aria-live="polite"></div>
            <button class="explanation-btn" id="explainBtn" style="display: none;">üìö Explain this answer</button>
            <div id="explanationPanel" class="explanation-panel" style="display: none;"></div>
        </div>

        <!-- Step 3: Results -->
        <div id="step3" class="quiz-box hide">
            <div class="result">
                <div id="icon" style="font-size: 72px; margin-bottom: 20px;"></div>
                <h2 id="resultTitle"></h2>
                <div id="resultScore" class="score"></div>
                <p id="resultMsg"></p>
                <div id="categoryBreakdown"></div>
                <a href="/" class="result-btn-primary">Back to Home</a>
                <button class="result-btn-secondary" id="retryBtn">Retake Quiz</button>
            </div>
        </div>
            </div>
        </main>

        <nav class="bottom-nav" aria-label="Bottom navigation">
            <div class="bottom-inner">
                <a class="nav-item" href="/" aria-label="Home">
                    <span class="dot">üè†</span>
                    Home
                </a>
                <a class="nav-item" href="/concepts/http-methods.html" aria-label="Learn">
                    <span class="dot">üìö</span>
                    Learn
                </a>
                <a class="nav-item active" href="/ml-engineer-quiz.html" aria-label="Quiz">
                    <span class="dot">üìù</span>
                    Quiz
                </a>
                <a class="nav-item" href="/profile.html" aria-label="Profile">
                    <span class="dot">üë§</span>
                    Profile
                </a>
            </div>
        </nav>
    </div>

    <script>
        // Quiz state
        let questions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let selectedTopic = 'all';
        const answers = {};
        let currentQuestion = null;
        let userAnswer = null;
        let isAnswered = false;
        let domainStats = {};

        // DOM elements
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const startBtn = document.getElementById('startBtn');
        const retryBtn = document.getElementById('retryBtn');
        const topicSelect = document.getElementById('topicSelect');
        const explainBtn = document.getElementById('explainBtn');
        const explanationPanel = document.getElementById('explanationPanel');

        // Escape HTML
        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // Request AI explanation
        async function requestAiExplanation() {
            if (!currentQuestion) return;
            
            explainBtn.disabled = true;
            explainBtn.textContent = '‚è≥ Loading explanation...';
            explanationPanel.style.display = 'block';
            explanationPanel.innerHTML = '<div class="explanation-loading">Generating AI explanation...</div>';

            try {
                const payload = {
                    question_id: currentQuestion._id?.toString() || 'q-' + currentQuestionIndex,
                    question_text: currentQuestion.question_text,
                    user_answer: userAnswer || '',
                    correct_answer: currentQuestion.correct_answer,
                    is_correct: userAnswer === currentQuestion.correct_answer,
                    explanation_level: 'short',
                    quiz_id: 'ml-engineer-exam',
                    difficulty: 'medium'
                };

                const response = await fetch('/ai-explain.json', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.ok && result.short_explanation) {
                    let html = '<div style="white-space: pre-wrap;">' + escapeHtml(result.short_explanation) + '</div>';
                    
                    if (result.expandable && result.model) {
                        html += '<br><button class="explanation-btn" onclick="requestLongExplanation()">üìñ Read more</button>';
                    }
                    
                    if (result.model) {
                        html += '<div style="margin-top: 12px; font-size: 12px; color: rgba(255,255,255,0.5);">Powered by ' + escapeHtml(result.model) + '</div>';
                    }
                    
                    explanationPanel.innerHTML = html;
                } else {
                    explanationPanel.innerHTML = '<div class="explanation-error">Could not generate explanation. Using stored explanation instead.</div>';
                    if (currentQuestion.explanation) {
                        explanationPanel.innerHTML += '<div style="white-space: pre-wrap;">' + escapeHtml(currentQuestion.explanation) + '</div>';
                    }
                }
            } catch (err) {
                console.error('Explanation error:', err);
                explanationPanel.innerHTML = '<div class="explanation-error">Error loading explanation</div>';
                if (currentQuestion.explanation) {
                    explanationPanel.innerHTML += '<div style="white-space: pre-wrap;">' + escapeHtml(currentQuestion.explanation) + '</div>';
                }
            } finally {
                explainBtn.disabled = false;
                explainBtn.textContent = 'üìö Explain this answer';
            }
        }

        // Request long explanation
        async function requestLongExplanation() {
            if (!currentQuestion) return;
            
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ Loading...';

            try {
                const payload = {
                    question_id: currentQuestion._id?.toString() || 'q-' + currentQuestionIndex,
                    question_text: currentQuestion.question_text,
                    user_answer: userAnswer || '',
                    correct_answer: currentQuestion.correct_answer,
                    is_correct: userAnswer === currentQuestion.correct_answer,
                    explanation_level: 'long',
                    quiz_id: 'ml-engineer-exam',
                    difficulty: 'medium'
                };

                const response = await fetch('/ai-explain.json', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.ok && result.long_explanation) {
                    const panel = document.getElementById('explanationPanel');
                    let html = '<div style="white-space: pre-wrap;">' + escapeHtml(result.long_explanation) + '</div>';
                    if (result.model) {
                        html += '<div style="margin-top: 12px; font-size: 12px; color: rgba(255,255,255,0.5);">Powered by ' + escapeHtml(result.model) + '</div>';
                    }
                    panel.innerHTML = html;
                }
            } catch (err) {
                console.error('Long explanation error:', err);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üìñ Read more';
            }
        }

        // Load questions from server
        async function loadQuestions() {
            try {
                const response = await fetch(`/ml-quiz-questions.json?phase=1`);
                const data = await response.json();
                questions = data.questions || [];
                
                if (questions.length === 0) {
                    startBtn.textContent = 'No questions available yet';
                    startBtn.disabled = true;
                }
            } catch (err) {
                console.error('Error loading questions:', err);
                startBtn.textContent = 'Error loading questions';
                startBtn.disabled = true;
            }
        }

        // Start quiz
        startBtn.addEventListener('click', () => {
            if (questions.length === 0) return;
            
            currentQuestionIndex = 0;
            score = 0;
            domainStats = {};
            selectedTopic = topicSelect.value;
            
            step1.classList.add('hide');
            step2.classList.remove('hide');
            showQuestion();
        });

        // Show current question
        function showQuestion() {
            if (currentQuestionIndex >= questions.length) {
                showResults();
                return;
            }

            const q = questions[currentQuestionIndex];
            currentQuestion = q;
            userAnswer = null;
            isAnswered = false;
            
            const progress = currentQuestionIndex + 1;
            const total = questions.length;
            
            document.getElementById('progressText').textContent = `Question ${progress} of ${total}`;
            document.getElementById('progressBar').style.width = `${(progress / total) * 100}%`;
            document.getElementById('sectionTitle').textContent = `Topic: ${q.domain || 'Unknown'}`;
            document.getElementById('question').textContent = q.question_text;

            // Render answer buttons
            const answersDiv = document.getElementById('answers');
            answersDiv.innerHTML = '';
            
            if (q.options && Array.isArray(q.options)) {
                q.options.forEach((option, idx) => {
                    const btn = document.createElement('button');
                    btn.textContent = option;
                    btn.onclick = () => selectAnswer(btn, q.correct_answer, idx, q);
                    answersDiv.appendChild(btn);
                });
            }

            document.getElementById('feedback').textContent = '';
            explainBtn.style.display = 'none';
            explanationPanel.style.display = 'none';
            explanationPanel.innerHTML = '';
        }

        // Handle answer selection
        function selectAnswer(button, correct, selectedIdx, q) {
            if (isAnswered) return; // Prevent double-clicking
            isAnswered = true;
            
            const correctIdx = ['A', 'B', 'C', 'D'].indexOf(correct);
            const isCorrect = selectedIdx === correctIdx;
            userAnswer = ['A', 'B', 'C', 'D'][selectedIdx];
            const answeredIndex = currentQuestionIndex;

            // Track domain-level progress
            const domain = (q && q.domain) ? String(q.domain) : 'Unknown';
            if (!domainStats[domain]) domainStats[domain] = { correct: 0, total: 0 };
            domainStats[domain].total += 1;
            if (isCorrect) domainStats[domain].correct += 1;

            // Disable all buttons
            document.querySelectorAll('.answers button').forEach(btn => btn.disabled = true);

            if (isCorrect) {
                button.classList.add('correct');
                document.getElementById('feedback').textContent = '‚úì Correct!';
                document.getElementById('feedback').className = 'feedback correct';
                score++;
            } else {
                button.classList.add('wrong');
                document.querySelectorAll('.answers button')[correctIdx].classList.add('correct');
                document.getElementById('feedback').textContent = '‚úó Incorrect. The correct answer is ' + ['A', 'B', 'C', 'D'][correctIdx];
                document.getElementById('feedback').className = 'feedback wrong';
            }

            // Use AI Quiz Assist for Continue vs auto-advance behavior
            const advance = () => {
                currentQuestionIndex++;
                showQuestion();
            };

            if (window.CzechLessonAiQuizAssist && window.CzechLessonAiQuizAssist.afterAnswer) {
                window.CzechLessonAiQuizAssist.afterAnswer({
                    quizId: 'ml-engineer-exam',
                    questionText: q.question_text,
                    userAnswer: q.options[selectedIdx] || '',
                    correctAnswer: q.options[correctIdx] || '',
                    isCorrect: isCorrect,
                    feedbackEl: document.getElementById('feedback').parentElement,
                    autoAdvanceDelayMs: 5000,
                    aiFetchTimeoutMs: 12000,
                    aiEnabled: true,
                    onAdvance: advance,
                    isStillCurrent: () => currentQuestionIndex === answeredIndex
                });
            } else {
                // Fallback if AI assist not loaded
                setTimeout(advance, 5000);
            }
        }

        // Show results
        function showResults() {
            step2.classList.add('hide');
            step3.classList.remove('hide');

            const percentage = Math.round((score / questions.length) * 100);
            const icon = percentage >= 70 ? '‚úì' : '‚óã';
            const status = percentage >= 70 ? 'Passed' : 'Keep Practicing';

            document.getElementById('icon').textContent = icon;
            document.getElementById('resultTitle').textContent = status;
            document.getElementById('resultScore').textContent = `${score} / ${questions.length} (${percentage}%)`;
            
            let msg = '';
            if (percentage >= 90) msg = 'Excellent! You have mastered this topic.';
            else if (percentage >= 70) msg = 'Good! You understand the core concepts. Review weak areas.';
            else msg = 'Keep studying! Review the definitions and try again.';
            
            document.getElementById('resultMsg').textContent = msg;

            // Persist attempt (best-effort; never block UX)
            (async () => {
                try {
                    const domain_stats = Object.entries(domainStats).map(([domain, s]) => ({
                        domain,
                        correct: s.correct,
                        total: s.total
                    }));

                    await fetch('/api/quiz/attempt', {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            quiz_id: 'ml-engineer-exam',
                            phase: 1,
                            score: score,
                            total: questions.length,
                            percentage: percentage,
                            domain_stats
                        })
                    });
                } catch (e) {
                    console.warn('Could not save quiz attempt:', e);
                }
            })();
        }

        // Retry quiz
        retryBtn.addEventListener('click', () => {
            step3.classList.add('hide');
            step1.classList.remove('hide');
        });

        // Load questions on page load
        loadQuestions();
    </script>
    <script src="/js/ai-quiz-assist.js"></script>
</body>
</html>
