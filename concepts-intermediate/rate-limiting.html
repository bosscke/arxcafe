<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rate Limiting</title>
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/concepts.css">
</head>
<body>
    <a href="/" class="home-btn">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 18px; height: 18px;">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
        </svg>
        Home
    </a>

    <div class="container">
        <h1>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 40px; height: 40px; display: inline-block; margin-right: 10px; vertical-align: middle;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v18m6-6H6"/></svg>
            Rate Limiting
        </h1>

        <div class="intro-box">
            <p><strong>Rate limiting</strong> controls how many requests a client can make in a time window. It protects services from abuse, ensures fair use, and stabilizes downstream dependencies.</p>
        </div>

        <h2>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 24px; height: 24px; display: inline-block; margin-right: 8px; vertical-align: middle;"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12h12M6 6h12M6 18h12"/></svg>
            Algorithms
        </h2>

        <div class="architecture-grid">
            <div class="arch-card">
                <h3>Token Bucket</h3>
                <p>Tokens refill at a rate; requests spend tokens. Allows bursts up to bucket size.</p>
            </div>
            <div class="arch-card">
                <h3>Leaky Bucket</h3>
                <p>Queue leaks at a constant rate; smooths bursts.</p>
            </div>
            <div class="arch-card">
                <h3>Fixed Window</h3>
                <p>Simple counters per window (e.g., per minute). Risk: boundary bursts.</p>
            </div>
            <div class="arch-card">
                <h3>Sliding Window</h3>
                <p>More accurate; uses rolling windows or sliding logs to reduce burst bias.</p>
            </div>
        </div>

        <h2>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 24px; height: 24px; display: inline-block; margin-right: 8px; vertical-align: middle;"><path stroke-linecap="round" stroke-linejoin="round" d="m6.75 7.5 4.5 9 4.5-9m-9 0 4.5-4.5 4.5 4.5m-9 0h9m-9 0L3 12l3.75-4.5m9 0L21 12l-3.75-4.5"/></svg>
            Examples
        </h2>

        <div style="background: rgba(102, 126, 234, 0.1); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; padding: 25px; margin: 30px 0; display: grid; gap: 18px;">
            <div>
                <h3>Express Middleware (Fixed Window, in-memory)</h3>
                <div style="background: #1e1e1e; color: #d4d4d4; padding: 12px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 10px; line-height: 1.6; overflow-wrap: break-word; word-wrap: break-word; border: 1px solid rgba(255, 255, 255, 0.1); white-space: pre-wrap; max-width: 100%; box-sizing: border-box;">
const express = require('express');
const app = express();
const limit = 100;
const windowMs = 60_000;
const hits = new Map();

app.use((req,res,next)=>{
  const key = req.ip;
  const now = Date.now();
  const entry = hits.get(key) || { count: 0, start: now };
  if (now - entry.start > windowMs) { entry.count = 0; entry.start = now; }
  entry.count += 1; hits.set(key, entry);
  if (entry.count > limit) return res.status(429).json({ error: 'rate limit' });
  next();
});

app.get('/hello', (req,res)=> res.json({ ok:true }));
app.listen(3000);
                </div>
            </div>
            <div>
                <h3>Token Bucket (concept)</h3>
                <div style="background: #1e1e1e; color: #d4d4d4; padding: 12px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 10px; line-height: 1.6; overflow-wrap: break-word; word-wrap: break-word; border: 1px solid rgba(255, 255, 255, 0.1); white-space: pre-wrap; max-width: 100%; box-sizing: border-box;">
state: tokens, lastRefill
on request:
  refill tokens += rate * (now - lastRefill)
  tokens = min(tokens, bucketSize)
  if tokens >= 1: tokens -= 1; allow
  else: reject 429
                </div>
            </div>
            <div>
                <h3>Headers to Return</h3>
                <div style="background: #1e1e1e; color: #d4d4d4; padding: 12px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 10px; line-height: 1.6; overflow-wrap: break-word; word-wrap: break-word; border: 1px solid rgba(255, 255, 255, 0.1); white-space: pre-wrap; max-width: 100%; box-sizing: border-box;">
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 42
X-RateLimit-Reset: 1704067200
Retry-After: 30
                </div>
            </div>
            <div>
                <h3>Distributed Store (Redis pseudo-code)</h3>
                <div style="background: #1e1e1e; color: #d4d4d4; padding: 12px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 10px; line-height: 1.6; overflow-wrap: break-word; word-wrap: break-word; border: 1px solid rgba(255, 255, 255, 0.1); white-space: pre-wrap; max-width: 100%; box-sizing: border-box;">
// using atomic INCR with TTL
await redis.multi()
  .set(key, 0, { NX: true, PX: windowMs })
  .incr(key)
  .pttl(key)
  .exec();
// if count > limit -> 429
                </div>
            </div>
        </div>

        <h2>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 24px; height: 24px; display: inline-block; margin-right: 8px; vertical-align: middle;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 3h3m-6 3h6M6.75 6h10.5a2.25 2.25 0 0 1 2.25 2.25v9A2.25 2.25 0 0 1 17.25 19.5H6.75A2.25 2.25 0 0 1 4.5 17.25v-9A2.25 2.25 0 0 1 6.75 6z"/></svg>
            Tips
        </h2>

        <div class="architecture-grid">
            <div class="arch-card">
                <h3>Scopes</h3>
                <p>Limit per user, IP, API key, or token. Use stricter limits for anonymous.</p>
            </div>
            <div class="arch-card">
                <h3>Burst vs Steady</h3>
                <p>Token buckets allow bursts; fixed windows are stricter. Choose per endpoint.</p>
            </div>
            <div class="arch-card">
                <h3>Priorities</h3>
                <p>Different limits for critical vs background traffic.</p>
            </div>
            <div class="arch-card">
                <h3>Observability</h3>
                <p>Log rate-limit hits, expose metrics, alert on high 429 rates.</p>
            </div>
        </div>

        <h2>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 24px; height: 24px; display: inline-block; margin-right: 8px; vertical-align: middle;"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z"/></svg>
            Best Practices
        </h2>

        <div class="pros-box">
            <h3>Do this:</h3>
            <ul class="features-list">
                <li>Document limits and headers</li>
                <li>Return 429 with Retry-After when blocked</li>
                <li>Use a shared store (Redis) for distributed systems</li>
                <li>Protect expensive endpoints with stricter caps</li>
                <li>Combine with auth scopes (user vs admin)</li>
            </ul>
        </div>

        <h2>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 24px; height: 24px; display: inline-block; margin-right: 8px; vertical-align: middle;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0zm-9 3.75h.008v.008H12v-.008z"/></svg>
            Common Pitfalls
        </h2>

        <div class="cons-box">
            <h3>Avoid these:</h3>
            <ul class="features-list">
                <li>No limits on unauthenticated traffic</li>
                <li>Inconsistent keys (mixing IP and user unpredictably)</li>
                <li>Unstable ordering when using sliding logs without cleanup</li>
                <li>Not communicating limits or reset times to clients</li>
            </ul>
        </div>

        <div class="intro-box" style="text-align: center; margin: 60px 0 40px;">
            <p>Rate limits keep APIs reliable. Pick an algorithm, scope it clearly, return helpful headers, and monitor 429s to tune fairness and safety.</p>
        </div>
    </div>
</body>
</html>
