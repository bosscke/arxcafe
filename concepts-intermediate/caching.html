<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caching</title>
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/concepts.css">
</head>
<body>
    <a href="/" class="home-btn">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 18px; height: 18px;">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
        </svg>
        Home
    </a>

    <div class="container">
        <h1>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 40px; height: 40px; display: inline-block; margin-right: 10px; vertical-align: middle;"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z"/></svg>
            Caching
        </h1>

        <div class="intro-box">
            <p>Caching stores frequently accessed data in a faster layer to reduce latency, cut load on downstream systems, and improve user experience. Done well, it can massively boost performance; done poorly, it can serve stale or inconsistent data.</p>
        </div>

        <h2>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 24px; height: 24px; display: inline-block; margin-right: 8px; vertical-align: middle;"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"/></svg>
            Cache Layers
        </h2>
        <div class="architecture-grid">
            <div class="arch-card">
                <h3>Client-Side</h3>
                <p>Browser cache, Service Workers, in-memory app caches.</p>
            </div>
            <div class="arch-card">
                <h3>CDN / Edge</h3>
                <p>Static assets, API edge caching, HTML caching for anonymous traffic.</p>
            </div>
            <div class="arch-card">
                <h3>Application Cache</h3>
                <p>In-memory (LRU), process-local or shared (Redis, Memcached).</p>
            </div>
            <div class="arch-card">
                <h3>Database Cache</h3>
                <p>Materialized views, query cache, read replicas as a "cache" for reads.</p>
            </div>
        </div>

        <h2>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 24px; height: 24px; display: inline-block; margin-right: 8px; vertical-align: middle;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/></svg>
            Cache Patterns
        </h2>
        <div class="architecture-grid">
            <div class="arch-card">
                <h3>Cache-Aside (Lazy Loading)</h3>
                <ul class="features-list">
                    <li>Read: check cache → miss → fetch DB → populate cache</li>
                    <li>Write: write DB, then invalidate cache</li>
                    <li>Most common; simple</li>
                </ul>
            </div>
            <div class="arch-card">
                <h3>Write-Through</h3>
                <ul class="features-list">
                    <li>Write goes to cache and DB simultaneously</li>
                    <li>Cache always warm; higher write latency</li>
                </ul>
            </div>
            <div class="arch-card">
                <h3>Write-Back (Write-Behind)</h3>
                <ul class="features-list">
                    <li>Write to cache; async flush to DB</li>
                    <li>Low write latency; risk of data loss if cache fails</li>
                </ul>
            </div>
            <div class="arch-card">
                <h3>Read-Through</h3>
                <ul class="features-list">
                    <li>App reads from cache API that fetches from DB on miss</li>
                    <li>Centralizes caching logic in cache service</li>
                </ul>
            </div>
        </div>

        <h2>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 24px; height: 24px; display: inline-block; margin-right: 8px; vertical-align: middle;"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5"/></svg>
            TTL, Eviction, and Invalidation
        </h2>
        <div class="pros-box">
            <h3>Key levers:</h3>
            <ul class="features-list">
                <li>TTL: how long items live before expiring</li>
                <li>Eviction: LRU, LFU, FIFO when memory is full</li>
                <li>Invalidation: explicit delete on writes; versioned keys</li>
                <li>Stale-while-revalidate: serve stale, refresh in background</li>
                <li>Cache warming: pre-populate after deploy</li>
            </ul>
        </div>

        <h2>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 24px; height: 24px; display: inline-block; margin-right: 8px; vertical-align: middle;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75m-3-7.036A11.959 11.959 0 0 1 3.598 6 11.99 11.99 0 0 0 3 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285Z"/></svg>
            Cache Keys and Versioning
        </h2>
        <div class="intro-box">
            <p>Design stable, unique keys. Include versions so you can invalidate whole classes of entries by bumping a prefix.</p>
        </div>
        <div style="background: #1e1e1e; color: #d4d4d4; padding: 14px; border-radius: 10px; font-family: 'Courier New', monospace; font-size: 10px; line-height: 1.6; border: 1px solid rgba(255,255,255,0.1); white-space: pre-wrap; overflow-wrap: break-word; margin-top: 16px;">
// Versioned key pattern
const VERSION = 'v2';
const key = `${VERSION}:user:${userId}`;

// Invalidate by bumping VERSION to v3 on deploy/schema change
        </div>

        <h2>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 24px; height: 24px; display: inline-block; margin-right: 8px; vertical-align: middle;"><path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75 22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3-4.5 16.5"/></svg>
            Example: Cache-Aside with Redis
        </h2>
        <div style="background: rgba(102, 126, 234, 0.1); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; padding: 25px; margin: 30px 0; display: grid; gap: 18px;">
            <div>
                <h3>Get with Cache</h3>
                <div style="background: #1e1e1e; color: #d4d4d4; padding: 12px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 10px; line-height: 1.6; overflow-wrap: break-word; word-wrap: break-word; border: 1px solid rgba(255, 255, 255, 0.1); white-space: pre-wrap; max-width: 100%; box-sizing: border-box;">
async function getUser(id) {
  const key = `user:${id}`;
  const cached = await redis.get(key);
  if (cached) return JSON.parse(cached);

  const user = await db.users.findOne({ _id: id });
  if (user) {
    await redis.setex(key, 3600, JSON.stringify(user));
  }
  return user;
}
                </div>
            </div>
            <div>
                <h3>Update with Invalidate</h3>
                <div style="background: #1e1e1e; color: #d4d4d4; padding: 12px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 10px; line-height: 1.6; overflow-wrap: break-word; word-wrap: break-word; border: 1px solid rgba(255, 255, 255, 0.1); white-space: pre-wrap; max-width: 100%; box-sizing: border-box;">
async function updateUser(id, patch) {
  await db.users.updateOne({ _id: id }, { $set: patch });
  await redis.del(`user:${id}`); // invalidate
}
                </div>
            </div>
            <div>
                <h3>Prevent Cache Stampede</h3>
                <div style="background: #1e1e1e; color: #d4d4d4; padding: 12px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 10px; line-height: 1.6; overflow-wrap: break-word; word-wrap: break-word; border: 1px solid rgba(255, 255, 255, 0.1); white-space: pre-wrap; max-width: 100%; box-sizing: border-box;">
// Use request coalescing and jittered TTL
const baseTtl = 3600;
const jitter = Math.floor(Math.random() * 300); // up to +5 minutes
await redis.setex(key, baseTtl + jitter, JSON.stringify(value));
                </div>
            </div>
        </div>

        <h2>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 24px; height: 24px; display: inline-block; margin-right: 8px; vertical-align: middle;"><path stroke-linecap="round" stroke-linejoin="round" d="m6.75 7.5 4.5 9 4.5-9m-9 0 4.5-4.5 4.5 4.5m-9 0h9m-9 0L3 12l3.75-4.5m9 0L21 12l-3.75-4.5"/></svg>
            CDN Caching Basics
        </h2>
        <div class="architecture-grid">
            <div class="arch-card">
                <h3>Cache-Control</h3>
                <p>Set `Cache-Control: public, max-age=31536000, immutable` for static assets.</p>
            </div>
            <div class="arch-card">
                <h3>ETag / Last-Modified</h3>
                <p>Conditional requests to validate freshness without full transfer.</p>
            </div>
            <div class="arch-card">
                <h3>Versioned Assets</h3>
                <p>Use content hashes in filenames to bust caches on deploy.</p>
            </div>
            <div class="arch-card">
                <h3>HTML Caching</h3>
                <p>Cache anonymous pages at edge; bypass for personalized content.</p>
            </div>
        </div>

        <h2>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 24px; height: 24px; display: inline-block; margin-right: 8px; vertical-align: middle;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/></svg>
            Metrics
        </h2>
        <div class="architecture-grid">
            <div class="arch-card">
                <h3>Hit Ratio</h3>
                <p>Cache hits / total requests. Aim high; monitor per keyspace.</p>
            </div>
            <div class="arch-card">
                <h3>Latency</h3>
                <p>P50/P90/P99 response time from cache vs origin.</p>
            </div>
            <div class="arch-card">
                <h3>Evictions</h3>
                <p>Track eviction rate; indicates pressure or hot keys.</p>
            </div>
            <div class="arch-card">
                <h3>Errors</h3>
                <p>Cache availability and timeouts; fail open vs fail closed strategies.</p>
            </div>
        </div>

        <h2>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 24px; height: 24px; display: inline-block; margin-right: 8px; vertical-align: middle;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75m-3-7.036A11.959 11.959 0 0 1 3.598 6 11.99 11.99 0 0 0 3 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285Z"/></svg>
            Best Practices
        </h2>
        <div class="pros-box">
            <h3>Do this:</h3>
            <ul class="features-list">
                <li>Cache hot, read-heavy data with clear TTLs</li>
                <li>Invalidate on writes; prefer cache-aside</li>
                <li>Add jitter to TTLs to avoid stampedes</li>
                <li>Use versioned keys for schema/deploy changes</li>
                <li>Monitor hit ratio, latency, evictions</li>
                <li>Encrypt sensitive data or avoid caching it</li>
                <li>Plan fail-open/closed behavior if cache is down</li>
            </ul>
        </div>

        <h2>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 24px; height: 24px; display: inline-block; margin-right: 8px; vertical-align: middle;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0zm-9 3.75h.008v.008H12v-.008z"/></svg>
            Common Pitfalls
        </h2>
        <div class="cons-box">
            <h3>Avoid these:</h3>
            <ul class="features-list">
                <li>Serving stale data due to missing invalidation</li>
                <li>Cache stampedes on popular keys expiring simultaneously</li>
                <li>Over-caching dynamic or personalized data</li>
                <li>Unbounded cache growth (no TTL/eviction)</li>
                <li>Missing cache key versioning; hard to invalidate</li>
                <li>Assuming cache writes are durable (they are not)</li>
                <li>Not measuring hit ratio; blind caching</li>
            </ul>
        </div>

        <div class="intro-box" style="text-align: center; margin: 60px 0 40px;">
            <p>Caching is a performance multiplier when paired with correct invalidation, TTLs, and monitoring. Design keys and strategies up front to avoid serving stale or incorrect data.</p>
        </div>
    </div>
</body>
</html>
